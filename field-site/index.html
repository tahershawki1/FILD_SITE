<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ©</title>
  <meta name="theme-color" content="#63a5ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Field Site">
  <link rel="manifest" href="./manifest.json">

  <!--
    ========================= MAIN PROJECT COMMENT =========================
    âš ï¸ WARNING FOR ANY AGENT / DEVELOPER (DO NOT DELETE) âš ï¸
    - Ù…Ù…Ù†ÙˆØ¹ Ø­Ø°Ù Ø£ÙŠ Ø¨Ù„ÙˆÙƒ ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„ÙŠÙ‡ "MAIN PROJECT COMMENT" ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
    - Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¬Ø²Ø¡ Ù…Ù† ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù„Ù ÙˆØªÙ‚Ø³ÙŠÙ…Ù‡ (Pages/Sections/Storage).
    - Ø­Ø°ÙÙ‡Ø§ ÙŠØ¶ÙŠÙ‘Ø¹ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆÙŠØµØ¹Ù‘Ø¨ Ø§Ù„ØªØ·ÙˆÙŠØ± Ù„Ø§Ø­Ù‚Ù‹Ø§.
    =======================================================================
  -->

  <!--
    ========================= PAGE MAP (DO NOT DELETE) ======================
    Virtual pages inside ONE file:
      1) HOME_PAGE  : Cards list (project work items)  -> #viewHome
      2) TASK_PAGE  : Details for selected card        -> #viewTask

    Special Task UI:
      - taskId === "new-level" -> "Ø¹Ù„Ø§Ù… Ø¬ÙŠØª Ù„ÙÙ„ Ø¬Ø¯ÙŠØ¯" has a custom form + calculators.

    Storage:
      - localStorage key: field_site_onefile_v5
      - state = { activeTaskId, tasksData }
      - tasksData[taskId] varies by task type (new-level has extra fields).
    =======================================================================
  -->

  <link rel="stylesheet" href="./assets/css/style.css">
</head>

<body>
  <!--
    ========================= MAIN PROJECT COMMENT =========================
    âš ï¸ DO NOT DELETE MAIN COMMENTS âš ï¸
    - Body contains HOME_PAGE and TASK_PAGE in one file.
    - JS toggles view and renders special UI for "new-level".
    =======================================================================
  -->

  <header class="premium-header">
    <div class="wrap">
      <div class="headRow">
        <div class="header-brand">
          <div class="logo-icon">
            <img src="./assets/icons/brand-logo.png" alt="Field Site Logo" class="brand-logo-img">
          </div>
          <div style="min-width:0">
            <h1 class="h1" id="topTitle">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ</h1>
            <p class="sub" id="topSub">Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© Ù…Ø¹ Ø§Ù„ØµÙˆØ±</p>
          </div>
        </div>
        <div class="headActions">
          <button id="themeToggle" class="btn-icon" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø±">â˜€ï¸</button>
          <a href="/logout" class="btn-icon logout-btn" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" aria-label="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">âŽ‹</a>
        </div>
      </div>
    </div>
  </header>

  <div id="updateBanner" class="premium-banner" hidden>
    <div class="banner-content">
      <div class="banner-icon">â¬‡ï¸</div>
      <div>
        <p class="banner-title">Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…ØªØ§Ø­Ø©</p>
        <span id="updateText" class="banner-desc">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…ÙŠØ²Ø§Øª</span>
      </div>
    </div>
    <div class="updateActions">
      <button id="btnUpdateNow" class="btn primary-small">ØªØ­Ø¯ÙŠØ«</button>
      <button id="btnLater" class="btn-text">Ù„Ø§Ø­Ù‚Ù‹Ø§</button>
    </div>
  </div>

  <main class="content-wrapper">
    <div class="wrap safePad">

      <!-- ========================= PAGE: HOME_PAGE ========================= -->
      <section class="view active" id="viewHome">
        <div class="home-intro">
          <p class="intro-text">Ø§Ø®ØªØ± Ø¨Ù†Ø¯ Ù…Ù† Ø§Ù„Ø£Ø¨Ù†Ø§Ø¯ Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¨Ø¯Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±</p>
        </div>
        <section class="cards-grid" id="cards"></section>
        <div class="grid-footer" id="gridFooter" style="display:none;">
          <p class="completion-text">ðŸ“Š Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!</p>
        </div>
      </section>

      <!-- ========================= PAGE: TASK_PAGE ========================= -->
      <section class="view" id="viewTask">
        <div class="task-header">
          <button class="btn-back" id="btnBack">
            <span class="back-icon">â¬…ï¸</span>
            Ø§Ù„Ø¹ÙˆØ¯Ø©
          </button>
          <button class="btn-reset" id="btnResetTask">
            <span class="reset-icon">ðŸ—‘ï¸</span>
            Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
          </button>
        </div>

        <section class="task-card">
          <div class="task-title-section">
            <h2 class="h2" id="taskTitle">â€”</h2>
            <p class="sub" id="taskDesc">â€”</p>
          </div>
          <div class="steps" id="stepsBar" style="display:none"></div>
        </section>

        <div id="taskBody" class="task-body-container"></div>
      </section>

    </div>
  </main>

  <!-- Scripts -->
    <script src="./assets/JS/script.js" defer></script>
  <script>
    (() => {
      if (!("serviceWorker" in navigator)) return;

      const banner = document.getElementById("updateBanner");
      const updateNowBtn = document.getElementById("btnUpdateNow");
      const laterBtn = document.getElementById("btnLater");
      const updateText = document.getElementById("updateText");
      const VERSION_KEY = "field_site_seen_version";

      let registrationRef = null;
      let waitingWorker = null;
      let refreshing = false;
      let latestVersion = "";

      function showUpdateBanner(version) {
        if (!banner) return;
        if (updateText && version) {
          updateText.textContent = `نسخة جديدة (${version}) متاحة للتطبيق.`;
        } else if (updateText) {
          updateText.textContent = "نسخة جديدة متاحة للتطبيق.";
        }
        banner.hidden = false;
      }

      function hideUpdateBanner() {
        if (!banner) return;
        banner.hidden = true;
      }

      function rememberVersion(version) {
        if (!version) return;
        try {
          localStorage.setItem(VERSION_KEY, version);
        } catch (_) {}
      }

      function getRememberedVersion() {
        try {
          return localStorage.getItem(VERSION_KEY) || "";
        } catch (_) {
          return "";
        }
      }

      async function fetchLatestVersion() {
        try {
          const response = await fetch("./version.json", { cache: "no-store" });
          if (!response.ok) return "";
          const payload = await response.json();
          return payload.version || "";
        } catch (_) {
          return "";
        }
      }

      async function markWorkerWaiting(worker) {
        if (!worker) return;
        waitingWorker = worker;
        if (!latestVersion) {
          latestVersion = await fetchLatestVersion();
        }
        showUpdateBanner(latestVersion);
      }

      async function detectVersionChangeOnly() {
        latestVersion = await fetchLatestVersion();
        if (!latestVersion) return;

        const seen = getRememberedVersion();
        if (!seen) {
          rememberVersion(latestVersion);
          return;
        }

        if (seen !== latestVersion) {
          showUpdateBanner(latestVersion);
        }
      }

      async function checkForUpdates() {
        if (!registrationRef) return;

        await registrationRef.update().catch(() => {});
        if (registrationRef.waiting) {
          await markWorkerWaiting(registrationRef.waiting);
          return;
        }

        await detectVersionChangeOnly();
      }

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (refreshing) return;
        refreshing = true;
        if (latestVersion) {
          rememberVersion(latestVersion);
        }
        window.location.reload();
      });

      if (updateNowBtn) {
        updateNowBtn.addEventListener("click", async () => {
          if (waitingWorker) {
            waitingWorker.postMessage({ type: "SKIP_WAITING" });
            return;
          }

          await checkForUpdates();
          if (!waitingWorker) {
            if (latestVersion) rememberVersion(latestVersion);
            window.location.reload();
          }
        });
      }

      if (laterBtn) {
        laterBtn.addEventListener("click", hideUpdateBanner);
      }

      window.addEventListener("load", async () => {
        try {
          const registration = await navigator.serviceWorker.register("./sw.js");
          registrationRef = registration;
          console.log("SW registered:", registration);

          latestVersion = await fetchLatestVersion();
          if (latestVersion && !getRememberedVersion()) {
            rememberVersion(latestVersion);
          }

          if (registration.waiting) {
            await markWorkerWaiting(registration.waiting);
          }

          registration.addEventListener("updatefound", () => {
            const installingWorker = registration.installing;
            if (!installingWorker) return;

            installingWorker.addEventListener("statechange", async () => {
              if (
                installingWorker.state === "installed" &&
                navigator.serviceWorker.controller
              ) {
                await markWorkerWaiting(installingWorker);
              }
            });
          });

          setInterval(checkForUpdates, 45 * 1000);
          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
              checkForUpdates();
            }
          });
        } catch (registrationError) {
          console.log("SW registration failed:", registrationError);
        }
      });
    })();
  </script>
</body>
</html>




