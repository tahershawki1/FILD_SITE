<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ุงููููุน ุงูููุฏุงูู - ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ุงูููุฏุงููุฉ</title>
  <meta name="theme-color" content="#63a5ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Field Site">
  <link rel="manifest" href="./manifest.json">

  <!--
    ========================= MAIN PROJECT COMMENT =========================
    โ๏ธ WARNING FOR ANY AGENT / DEVELOPER (DO NOT DELETE) โ๏ธ
    - ููููุน ุญุฐู ุฃู ุจููู ุชุนููู ุนููู "MAIN PROJECT COMMENT" ูู ุงููุดุฑูุน ุจุงููุงูู.
    - ุงูุชุนูููุงุช ุงูุฑุฆูุณูุฉ ุฌุฒุก ูู ุชูุธูู ุงูููู ูุชูุณููู (Pages/Sections/Storage).
    - ุญุฐููุง ูุถููุน ูููู ุงููุดุฑูุน ููุตุนูุจ ุงูุชุทููุฑ ูุงุญููุง.
    =======================================================================
  -->

  <!--
    ========================= PAGE MAP (DO NOT DELETE) ======================
    Virtual pages inside ONE file:
      1) HOME_PAGE  : Cards list (project work items)  -> #viewHome
      2) TASK_PAGE  : Details for selected card        -> #viewTask

    Special Task UI:
      - taskId === "new-level" -> "ุนูุงู ุฌูุช ููู ุฌุฏูุฏ" has a custom form + calculators.

    Storage:
      - localStorage key: field_site_onefile_v5
      - state = { activeTaskId, tasksData }
      - tasksData[taskId] varies by task type (new-level has extra fields).
    =======================================================================
  -->

  <link rel="stylesheet" href="./assets/css/style.css">
</head>

<body>
  <!--
    ========================= MAIN PROJECT COMMENT =========================
    โ๏ธ DO NOT DELETE MAIN COMMENTS โ๏ธ
    - Body contains HOME_PAGE and TASK_PAGE in one file.
    - JS toggles view and renders special UI for "new-level".
    =======================================================================
  -->

  <header class="premium-header">
    <div class="wrap">
      <div class="headRow">
        <div class="header-brand">
          <div class="logo-icon">
            <img src="./assets/icons/brand-logo.png" alt="Field Site Logo" class="brand-logo-img">
          </div>
          <div style="min-width:0">
            <h1 class="h1" id="topTitle">ุงููููุน ุงูููุฏุงูู</h1>
            <p class="sub" id="topSub">ุฅุฏุงุฑุฉ ุจููุฏ ุงูุนูู ูุงูุจูุงูุงุช ุงูููุฏุงููุฉ ูุน ุงูุตูุฑ</p>
          </div>
        </div>
        <div class="headActions">
          <button id="themeToggle" class="btn-icon" title="ุชุจุฏูู ุงููุธูุฑ">โ๏ธ</button>
          <a href="/logout" class="btn-icon logout-btn" title="ุชุณุฌูู ุงูุฎุฑูุฌ" aria-label="ุชุณุฌูู ุงูุฎุฑูุฌ">โ</a>
        </div>
      </div>
    </div>
  </header>

  <div id="updateBanner" class="premium-banner" hidden>
    <div class="banner-content">
      <div class="banner-icon">โฌ๏ธ</div>
      <div>
        <p class="banner-title">ูุณุฎุฉ ุฌุฏูุฏุฉ ูุชุงุญุฉ</p>
        <span id="updateText" class="banner-desc">ุชุญุฏูุซ ุงูุชุทุจูู ููุญุตูู ุนูู ุฃุญุฏุซ ุงูููุฒุงุช</span>
      </div>
    </div>
    <div class="updateActions">
      <button id="btnUpdateNow" class="btn primary-small">ุชุญุฏูุซ</button>
      <button id="btnLater" class="btn-text">ูุงุญููุง</button>
    </div>
  </div>

  <main class="content-wrapper">
    <div class="wrap safePad">

      <!-- ========================= PAGE: HOME_PAGE ========================= -->
      <section class="view active" id="viewHome">
        <div class="home-intro">
          <p class="intro-text">ุงุฎุชุฑ ุจูุฏ ูู ุงูุฃุจูุงุฏ ุฃุฏูุงู ูุจุฏุก ุฅุฏุฎุงู ุงูุจูุงูุงุช ูุงูุตูุฑ</p>
        </div>
        <section class="cards-grid" id="cards"></section>
        <div class="grid-footer" id="gridFooter" style="display:none;">
          <p class="completion-text">๐ ุงูุชููุช ุฌููุน ุงูุจููุฏ ุจูุฌุงุญ!</p>
        </div>
      </section>

      <!-- ========================= PAGE: TASK_PAGE ========================= -->
      <section class="view" id="viewTask">
        <div class="task-header">
          <button class="btn-back" id="btnBack">
            <span class="back-icon">โฌ๏ธ</span>
            ุงูุนูุฏุฉ
          </button>
          <button class="btn-reset" id="btnResetTask">
            <span class="reset-icon">๐๏ธ</span>
            ุฅุนุงุฏุฉ ุชุนููู
          </button>
        </div>

        <section class="task-card">
          <div class="task-title-section">
            <h2 class="h2" id="taskTitle">โ</h2>
            <p class="sub" id="taskDesc">โ</p>
          </div>
          <div class="steps" id="stepsBar" style="display:none"></div>
        </section>

        <div id="taskBody" class="task-body-container"></div>
      </section>

    </div>
  </main>

  <!-- Scripts -->
  <script src="./assets/JS/script.js" defer></script>
    <script>
    (() => {
      if (!("serviceWorker" in navigator)) return;

      const banner = document.getElementById("updateBanner");
      const updateNowBtn = document.getElementById("btnUpdateNow");
      const laterBtn = document.getElementById("btnLater");
      const updateText = document.getElementById("updateText");
      const VERSION_KEY = "field_site_seen_version";

      let registrationRef = null;
      let waitingWorker = null;
      let refreshing = false;
      let latestVersion = "";

      function showUpdateBanner(version) {
        if (!banner) return;
        if (updateText && version) {
          updateText.textContent = `ูุณุฎุฉ ุฌุฏูุฏุฉ (${version}) ูุชุงุญุฉ ููุชุทุจูู.`;
        } else if (updateText) {
          updateText.textContent = "ูุณุฎุฉ ุฌุฏูุฏุฉ ูุชุงุญุฉ ููุชุทุจูู.";
        }
        banner.hidden = false;
      }

      function hideUpdateBanner() {
        if (!banner) return;
        banner.hidden = true;
      }

      function rememberVersion(version) {
        if (!version) return;
        try {
          localStorage.setItem(VERSION_KEY, version);
        } catch (_) {}
      }

      function getRememberedVersion() {
        try {
          return localStorage.getItem(VERSION_KEY) || "";
        } catch (_) {
          return "";
        }
      }

      async function fetchLatestVersion() {
        try {
          const response = await fetch("./version.json", { cache: "no-store" });
          if (!response.ok) return "";
          const payload = await response.json();
          return payload.version || "";
        } catch (_) {
          return "";
        }
      }

      async function markWorkerWaiting(worker) {
        if (!worker) return;
        waitingWorker = worker;
        if (!latestVersion) {
          latestVersion = await fetchLatestVersion();
        }
        showUpdateBanner(latestVersion);
      }

      async function detectVersionChangeOnly() {
        latestVersion = await fetchLatestVersion();
        if (!latestVersion) return;

        const seen = getRememberedVersion();
        if (!seen) {
          rememberVersion(latestVersion);
          return;
        }

        if (seen !== latestVersion) {
          showUpdateBanner(latestVersion);
        }
      }

      async function checkForUpdates() {
        if (!registrationRef) return;

        await registrationRef.update().catch(() => {});
        if (registrationRef.waiting) {
          await markWorkerWaiting(registrationRef.waiting);
          return;
        }

        await detectVersionChangeOnly();
      }

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (refreshing) return;
        refreshing = true;
        if (latestVersion) {
          rememberVersion(latestVersion);
        }
        window.location.reload();
      });

      if (updateNowBtn) {
        updateNowBtn.addEventListener("click", async () => {
          if (waitingWorker) {
            waitingWorker.postMessage({ type: "SKIP_WAITING" });
            return;
          }

          await checkForUpdates();
          if (!waitingWorker) {
            if (latestVersion) rememberVersion(latestVersion);
            window.location.reload();
          }
        });
      }

      if (laterBtn) {
        laterBtn.addEventListener("click", hideUpdateBanner);
      }

      window.addEventListener("load", async () => {
        try {
          const registration = await navigator.serviceWorker.register("./sw.js");
          registrationRef = registration;
          console.log("SW registered:", registration);

          latestVersion = await fetchLatestVersion();
          if (latestVersion && !getRememberedVersion()) {
            rememberVersion(latestVersion);
          }

          if (registration.waiting) {
            await markWorkerWaiting(registration.waiting);
          }

          registration.addEventListener("updatefound", () => {
            const installingWorker = registration.installing;
            if (!installingWorker) return;

            installingWorker.addEventListener("statechange", async () => {
              if (
                installingWorker.state === "installed" &&
                navigator.serviceWorker.controller
              ) {
                await markWorkerWaiting(installingWorker);
              }
            });
          });

          setInterval(checkForUpdates, 45 * 1000);
          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
              checkForUpdates();
            }
          });
        } catch (registrationError) {
          console.log("SW registration failed:", registrationError);
        }
      });
    })();
  </script>
</body>
</html>

